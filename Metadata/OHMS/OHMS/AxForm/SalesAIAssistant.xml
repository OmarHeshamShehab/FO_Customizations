<?xml version="1.0" encoding="utf-8"?>
<AxForm xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns="Microsoft.Dynamics.AX.Metadata.V6">
	<Name>SalesAIAssistant</Name>
	<SourceCode>
		<Methods xmlns="">
			<Method>
				<Name>classDeclaration</Name>
				<Source><![CDATA[
/// <summary>
/// SalesAIAssistant — AI Sales Assistant Form
/// ===========================================
/// Main user interface form for the D365 Sales AI Assistant.
/// Provides a chat-style interface for sales representatives to ask
/// natural language questions about sales orders and customers.
///
/// Form Controls:
///   CustomerIdInput  — Optional customer account lookup (CustTable)
///   SalesOrderIdInput — Optional sales order lookup (SalesTable)
///   QuestionInput    — Free text natural language question input
///   AskButton        — Submits question to the AI assistant
///   ClearButton      — Clears all fields and resets the form
///   AnswerDisplay    — Displays the AI-generated answer with response time
///
/// Architecture:
///   Form → SalesAIAssistantService.askQuestion()
///     → Python /ask-text endpoint
///       → OData fetch from D365
///       → Ollama LLM (qwen3:8b)
///       → Plain text answer returned
///
/// Dependencies:
///   - SalesAIAssistantService: HTTP bridge to Python backend
///   - SalesAIAssistantParameters: API endpoint and timeout configuration
///
/// Notes:
///   - Form blocks during AI call (AOS thread limitation)
///   - Both AskButton and ClearButton are disabled during processing
///   - Response time is displayed at the bottom of every answer
///   - ClearButton resets all fields to initial ready state
///   - CustomerIdInput drives SalesOrderIdInput lookup filter
///   - AOS must be awake before submitting questions (OData dependency)
/// </summary>
[Form]
public class SalesAIAssistant extends FormRun
{
    // ── FORM CONTROL REFERENCES ───────────────────────────────────────────────

    // Service instance — initialized once in init() and reused for all calls
    SalesAIAssistantService     aiService;

    // Input controls
    FormStringControl           questionInput;      // Natural language question
    FormStringControl           custAccountControl; // Optional customer account filter
    FormStringControl           salesIdControl;     // Optional sales order filter

    // Output controls
    FormStringControl           answerDisplay;      // AI-generated answer display

    // Action controls
    FormButtonControl           askButton;          // Submit question to AI
    FormButtonControl           clearButton;        // Reset all fields


}
]]></Source>
			</Method>
			<Method>
				<Name>init</Name>
				<Source><![CDATA[
    // ── FORM LIFECYCLE ────────────────────────────────────────────────────────

    /// <summary>
    /// Initializes the form — binds control references, creates the AI service,
    /// and performs a health check to verify the Python backend is reachable.
    ///
    /// If the service is unavailable, displays troubleshooting instructions
    /// in the answer display area so the user knows what to fix.
    /// If the service is available, displays a ready message.
    /// </summary>
    public void init()
    {
        super();

        // Bind all form controls by their design-time names
        questionInput      = element.design().controlName('QuestionInput');
        answerDisplay      = element.design().controlName('AnswerDisplay');
        askButton          = element.design().controlName('AskButton');
        clearButton        = element.design().controlName('ClearButton');
        custAccountControl = element.design().controlName('CustomerIdInput');
        salesIdControl     = element.design().controlName('SalesOrderIdInput');

        // Initialize AI service — loads config from SalesAIAssistantParameters
        aiService = new SalesAIAssistantService();

        // Health check — verify Python server is running before user interacts
        if (!aiService.isServiceAvailable())
        {
            answerDisplay.text(
                "AI service is not reachable.\n\n"
                + "Please make sure:\n"
                + "1. Python server is running (uvicorn server:app --port 8000)\n"
                + "2. Ollama is running (ollama serve)\n"
                + "3. API endpoint: "
                + SalesAIAssistantParameters::find().APIEndpoint
            );
        }
        else
        {
            answerDisplay.text("AI Assistant is ready. Type your question and click Ask Assistant.");
        }

        // Set initial focus to question input for immediate typing
        questionInput.setFocus();
    }

]]></Source>
			</Method>
			<Method>
				<Name>close</Name>
				<Source><![CDATA[
    /// <summary>
    /// Handles form close — calls super() to perform standard cleanup.
    /// </summary>
    public void close()
    {
        super();
    }

]]></Source>
			</Method>
		</Methods>
		<DataSources xmlns="" />
		<DataControls xmlns="">
			<Control>
				<Name>CustomerIdInput</Name>
				<Type>String</Type>
				<Methods>
					<Method>
						<Name>lookup</Name>
						<Source><![CDATA[
        public void lookup()
        {
            SysTableLookup          sysTableLookup;
            QueryBuildDataSource    qbds;
            Query                   query;

            sysTableLookup = SysTableLookup::newParameters(tableNum(CustTable), this);
            sysTableLookup.addLookupField(fieldNum(CustTable, AccountNum));

            query = new Query();
            qbds  = query.addDataSource(tableNum(CustTable));
            qbds.addSortField(fieldNum(CustTable, AccountNum));

            sysTableLookup.parmQuery(query);
            sysTableLookup.performFormLookup();
        }

]]></Source>
					</Method>
				</Methods>
			</Control>
			<Control>
				<Name>SalesOrderIdInput</Name>
				<Type>String</Type>
				<Methods>
					<Method>
						<Name>lookup</Name>
						<Source><![CDATA[
        public void lookup()
        {
            SysTableLookup          sysTableLookup;
            QueryBuildDataSource    qbds;
            Query                   query;
            str                     custAccount;

            sysTableLookup = SysTableLookup::newParameters(tableNum(SalesTable), this);
            sysTableLookup.addLookupField(fieldNum(SalesTable, SalesId));
            sysTableLookup.addLookupField(fieldNum(SalesTable, CustAccount));
            sysTableLookup.addLookupField(fieldNum(SalesTable, SalesStatus));

            query = new Query();
            qbds  = query.addDataSource(tableNum(SalesTable));
            qbds.addSortField(fieldNum(SalesTable, SalesId), SortOrder::Descending);

            // Filter by customer if one is selected in CustomerIdInput
            custAccount = custAccountControl.text();
            if (custAccount)
            {
                qbds.addRange(fieldNum(SalesTable, CustAccount)).value(custAccount);
            }

            sysTableLookup.parmQuery(query);
            sysTableLookup.performFormLookup();
        }

]]></Source>
					</Method>
				</Methods>
			</Control>
			<Control>
				<Name>AskButton</Name>
				<Type>Button</Type>
				<Methods>
					<Method>
						<Name>clicked</Name>
						<Source><![CDATA[
        public void clicked()
        {
            str             question;
            str             orderId;
            str             customerId;
            str             answer;
            System.DateTime startTime;
            System.DateTime endTime;
            System.TimeSpan elapsed;
            int             totalSeconds;
            int             minutes;
            int             seconds;
            str             duration;

            // Read current values from all input controls
            question   = questionInput.text();
            orderId    = salesIdControl.text();
            customerId = custAccountControl.text();

            // Validate that a question was entered before submitting
            if (!question || strLen(strLTrim(strRTrim(question))) == 0)
            {
                warning("Please enter a question.");
                questionInput.setFocus();
                return;
            }

            // Show processing state — disable buttons to prevent double submission
            answerDisplay.text("Thinking... please wait.");
            askButton.enabled(false);
            clearButton.enabled(false);
            element.redraw();

            try
            {
                // Record start time before calling the AI service
                startTime = System.DateTime::get_UtcNow();

                // Call the AI service — this blocks the AOS thread until response
                answer = aiService.askQuestion(question, orderId, customerId);

                // Calculate elapsed response time
                endTime      = System.DateTime::get_UtcNow();
                elapsed      = endTime.Subtract(startTime);
                totalSeconds = System.Convert::ToInt32(elapsed.get_TotalSeconds());
                minutes      = totalSeconds / 60;
                seconds      = totalSeconds mod 60;

                // Format duration as "2m 34s" or "47s"
                if (minutes > 0)
                    duration = int2Str(minutes) + 'm ' + int2Str(seconds) + 's';
                else
                    duration = int2Str(seconds) + 's';

                // Display answer with response time footer
                answerDisplay.text(answer + "\n\n─────────────────────\nResponse time: " + duration);
            }
            catch (Exception::Error)
            {
                answerDisplay.text("An error occurred. Please try again.");
            }

            // Restore buttons and return focus to Ask button
            askButton.enabled(true);
            clearButton.enabled(true);
            askButton.setFocus();
        }

]]></Source>
					</Method>
				</Methods>
			</Control>
			<Control>
				<Name>ClearButton</Name>
				<Type>Button</Type>
				<Methods>
					<Method>
						<Name>clicked</Name>
						<Source><![CDATA[
        public void clicked()
        {
            // Clear all input fields
            questionInput.text('');
            salesIdControl.text('');
            custAccountControl.text('');

            // Reset answer display to initial ready message
            answerDisplay.text("AI Assistant is ready. Type your question and click Ask Assistant.");

            // Return focus to question input for next inquiry
            questionInput.setFocus();
        }

]]></Source>
					</Method>
				</Methods>
			</Control>
		</DataControls>
		<Members xmlns="" />
	</SourceCode>
	<DataSources />
	<Design>
		<Caption xmlns="">Sales AI Assistant</Caption>
		<Pattern xmlns="">Custom</Pattern>
		<ShowDeleteButton xmlns="">No</ShowDeleteButton>
		<ShowNewButton xmlns="">No</ShowNewButton>
		<Controls xmlns="">
			<AxFormControl xmlns=""
				i:type="AxFormGroupControl">
				<Name>InputGroup</Name>
				<Type>Group</Type>
				<FormControlExtension
					i:nil="true" />
				<Controls>
					<AxFormControl xmlns=""
						i:type="AxFormStringControl">
						<Name>CustomerIdInput</Name>
						<Type>String</Type>
						<Width>200</Width>
						<WidthMode>Manual</WidthMode>
						<FormControlExtension
							i:nil="true" />
						<Label>Customer Account</Label>
					</AxFormControl>
					<AxFormControl xmlns=""
						i:type="AxFormStringControl">
						<Name>SalesOrderIdInput</Name>
						<HeightMode>Auto</HeightMode>
						<Type>String</Type>
						<Width>200</Width>
						<WidthMode>Manual</WidthMode>
						<FormControlExtension
							i:nil="true" />
						<Label>Sales Order ID</Label>
					</AxFormControl>
				</Controls>
				<Columns>2</Columns>
				<Caption>Order &amp; Customer Context</Caption>
			</AxFormControl>
			<AxFormControl xmlns=""
				i:type="AxFormGroupControl">
				<Name>QuestionGroup</Name>
				<Type>Group</Type>
				<WidthMode>SizeToAvailable</WidthMode>
				<FormControlExtension
					i:nil="true" />
				<Controls>
					<AxFormControl xmlns=""
						i:type="AxFormStringControl">
						<Name>QuestionInput</Name>
						<Height>200</Height>
						<HeightMode>Manual</HeightMode>
						<Type>String</Type>
						<Width>600</Width>
						<WidthMode>Manual</WidthMode>
						<FormControlExtension
							i:nil="true" />
						<MultiLine>Yes</MultiLine>
					</AxFormControl>
				</Controls>
				<ColumnsMode>Fill</ColumnsMode>
				<Caption>Your Question</Caption>
			</AxFormControl>
			<AxFormControl xmlns=""
				i:type="AxFormButtonGroupControl">
				<Name>ButtonGroup</Name>
				<Type>ButtonGroup</Type>
				<FormControlExtension
					i:nil="true" />
				<Controls>
					<AxFormControl xmlns=""
						i:type="AxFormButtonControl">
						<Name>AskButton</Name>
						<Type>Button</Type>
						<Width>150</Width>
						<WidthMode>Manual</WidthMode>
						<FormControlExtension
							i:nil="true" />
						<ButtonDisplay>TextOnly</ButtonDisplay>
						<Text>Ask Assistant</Text>
					</AxFormControl>
					<AxFormControl xmlns=""
						i:type="AxFormButtonControl">
						<Name>ClearButton</Name>
						<Type>Button</Type>
						<FormControlExtension
							i:nil="true" />
						<Text>Clear</Text>
					</AxFormControl>
				</Controls>
				<Columns>2</Columns>
				<ColumnsMode>Fill</ColumnsMode>
				<FrameType>None</FrameType>
			</AxFormControl>
			<AxFormControl xmlns=""
				i:type="AxFormGroupControl">
				<Name>AnswerGroup</Name>
				<Height>1600</Height>
				<HeightMode>Manual</HeightMode>
				<Type>Group</Type>
				<Width>1600</Width>
				<WidthMode>Manual</WidthMode>
				<FormControlExtension
					i:nil="true" />
				<Controls>
					<AxFormControl xmlns=""
						i:type="AxFormStringControl">
						<Name>AnswerDisplay</Name>
						<AllowEdit>No</AllowEdit>
						<Height>1600</Height>
						<HeightMode>Manual</HeightMode>
						<Type>String</Type>
						<Width>1600</Width>
						<WidthMode>Manual</WidthMode>
						<FormControlExtension
							i:nil="true" />
						<MultiLine>Yes</MultiLine>
					</AxFormControl>
				</Controls>
				<ColumnsMode>Fill</ColumnsMode>
				<Caption>Answer</Caption>
			</AxFormControl>
		</Controls>
	</Design>
	<Parts />
</AxForm>